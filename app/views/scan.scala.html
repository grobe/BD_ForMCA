<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>TEst of the API files</title>




</head>
<body>
@helper.form(action = routes.BdController.listBD, 'enctype -> "multipart/form-data") {

    <input type="file" name="picture" id="picture">
    
     

    <p>
        <input type="submit">
    </p>
    
    <canvas id="canvas" crossOrigin="anynymous" width="100" height="100"></canvas>
    
} 

<div id="size">

</div>


<div id="name">

</div>
<div id="fic"> </div>

<img src="http://placekitten.com/g/320/261" crossOrigin="anynymous" width="100" height="100" id="photo" alt="photo">



<script>
console.log("Start");

//if (filesToUpload){
	document.getElementById("picture").addEventListener("change",handleFiles , false);	

//}

document.getElementById('size').innerHTML  ="no value 1";
document.getElementById('name').innerHTML  = "No value 2";
document.getElementById('fic').innerHTML  = "No value 3";
var FileToSend  = document.getElementById('canvas');

		function handleFiles(evt) {
		//        var files = this.files; /* now you can work with the file list */
		        var files = evt.target.files;
		       // var f = files[0];
		       // var reader = new FileReader();
		
				
		       var photo        = document.getElementById('photo');
		        var dislaySize = document.getElementById('size');
				var dislayName = document.getElementById('name');
				
				//photo.crossOrigin='anonymous';
				  
		         
				var file = files[0];
				
				//file.crossOrigin='anonymous';
				  
				
				dislaySize.innerHTML  = file.size;
				dislayName.innerHTML  = file.name;
				
				 var reader = new FileReader();
	
				 
				 
				 reader.onload = function(event) {
					    var dataUri = event.target.result,
					        canvas  = document.getElementById('canvas'),
					        context = document.getElementById("canvas").getContext("2d"),
					        img     = document.getElementById('photo');
					  
						
					  
					    // wait until the image has been fully processed
					    img.onload = function() {
					    	canvas.width = photo.width/2;
							canvas.height = photo.height/2;
					        context.drawImage(img, 0, 0, photo.width/2, photo.height/2);
					    };
					    img.src = dataUri;
					    //image.src=canvas.toDataURL();
					    
					};

				 console.log("before readAsDataURL");
				 reader.readAsDataURL(file);
				 console.log("before sendFile");
				 //canvas.toDataURL()
				 sendFile (file);
				 console.log("END");
					 
				 
				 

				 
		
							 
		}			 

		 
		
function sendFile (file){
	
	//var img = canevas.toDataURL();
	//var file = dataURItoBlob(img);
	
	var formData =new FormData();
	   
	  formData.append("picture", file);
	
	var request = new Request('http://localhost:9000/listBD', {
		method: 'POST',
		body: formData
		//mode: 'cors', 
		/*redirect: 'follow',
		//headers: new Headers({
		//	'Content-Type': 'text/plain'
		})*/
	});

	// Now use it!
	fetch(request).then(function(returnedValue) {document.getElementById('fic').innerHTML=returnedValue; });
}
		 
function dataURItoBlob(dataURI) {
    // convert base64/URLEncoded data component to raw binary data held in a string
    var byteString;
    if (dataURI.split(',')[0].indexOf('base64') >= 0)
        byteString = atob(dataURI.split(',')[1]);
    else
        byteString = unescape(dataURI.split(',')[1]);
    // separate out the mime component
    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
    // write the bytes of the string to a typed array
    var ia = new Uint8Array(byteString.length);
    for (var i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    return new Blob([ia], {type:mimeString});
}		

</script>


</body>
</html>